<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Evaluation Dashboard (Fixed & Sync)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #34495e; }
        
        #loginPage { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%); }
        .login-card { max-width: 400px; width: 100%; padding: 20px; border-radius: 15px; }
        
        .main-content { display: none; padding: 30px; }
        .table-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .scoring-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1050; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        
        .audio-card { border-left: 5px solid #3498db; background: #f8f9fa; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        .btn-play { padding: 5px 15px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="card login-card shadow">
            <div class="card-body text-center">
                <h3 class="mb-4">Dashboard Login</h3>
                <input type="password" id="adminPass" class="form-control mb-3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                <button id="loginBtn" class="btn btn-primary w-100">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div id="mainContent" class="main-content container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold"><i class="bi bi-speedometer2"></i> Simulator Dashboard</h2>
            <button id="logoutBtn" class="btn btn-outline-danger btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="table-container">
            <div class="row g-3 mb-4 align-items-end">
                <div class="col-md-3"><label class="small">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label><input type="date" id="startDate" class="form-control"></div>
                <div class="col-md-3"><label class="small">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" id="endDate" class="form-control"></div>
                <div class="col-md-2"><button id="filterBtn" class="btn btn-primary w-100"><i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button></div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</th>
                            <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="submissionTable">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="scoring-modal">
        <div class="modal-content shadow-lg">
            <div class="d-flex justify-content-between">
                <h4><i class="bi bi-person-check"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•: <span id="modalTraineeName" class="text-primary"></span></h4>
                <button onclick="closeModal()" class="btn-close"></button>
            </div>
            <hr>
            
            <div class="row">
                <div class="col-md-6 border-end">
                    <h6 class="fw-bold mb-3 text-secondary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h6>
                    <div id="audioPlaylist" style="max-height: 450px; overflow-y: auto; padding-right: 10px;">
                        <div class="text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...</div>
                    </div>
                </div>

                <div class="col-md-6 ps-4">
                    <h6 class="fw-bold mb-3 text-secondary">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h6>
                    <div class="row g-3">
                        <div class="col-6"><label>Step 1 (5)</label><input type="number" id="s1" class="form-control" max="5"></div>
                        <div class="col-6"><label>Step 2 (5)</label><input type="number" id="s2" class="form-control" max="5"></div>
                        <div class="col-6"><label>Step 3 (5)</label><input type="number" id="s3" class="form-control" max="5"></div>
                        <div class="col-6"><label>Step 4 (5)</label><input type="number" id="s4" class="form-control" max="5"></div>
                        <div class="col-12"><label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</label><textarea id="feedback" class="form-control" rows="3"></textarea></div>
                    </div>
                    <button id="saveManualBtn" class="btn btn-success w-100 mt-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Config ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const VALID_PASS = "1234";
        let currentScoringId = null;

        // Login Logic
        document.getElementById('loginBtn').onclick = () => {
            if(document.getElementById('adminPass').value === VALID_PASS) {
                document.getElementById('loginPage').style.display = "none";
                document.getElementById('mainContent').style.display = "block";
                fetchSubmissions();
            } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
        };

        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ Part 0)
        async function fetchSubmissions() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            let query = supabase.from('submissions').select('*').eq('part_number', 0).order('created_at', { ascending: false });

            if(start && end) {
                query = query.gte('created_at', `${start} 00:00:00`).lte('created_at', `${end} 23:59:59`);
            }

            const { data, error } = await query;
            const tbody = document.getElementById('submissionTable');
            tbody.innerHTML = '';

            if(data) {
                data.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="small">${new Date(item.created_at).toLocaleString('th-TH')}</td>
                            <td class="fw-bold">${item.name}</td>
                            <td>${item.user_group || '-'}</td>
                            <td><span class="badge bg-light text-dark border">${item.question_text}</span></td>
                            <td><span class="badge bg-primary">${item.manual_score || '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'}</span></td>
                            <td><button onclick="openModal('${item.id}', '${item.name}', '${item.user_id}')" class="btn btn-sm btn-primary">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button></td>
                        </tr>`;
                });
            }
        }

        // 2. ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô Modal
        window.openModal = async (id, name, userId) => {
            currentScoringId = id;
            document.getElementById('modalTraineeName').textContent = name;
            document.getElementById('scoringModal').style.display = 'flex';
            
            const playlist = document.getElementById('audioPlaylist');
            playlist.innerHTML = '<div class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...</div>';

            // ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏¢‡πà‡∏≠‡∏¢ (Part 1-5) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏´‡∏±‡∏™ user_id ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
            const { data: audios } = await supabase.from('submissions')
                .select('*')
                .eq('user_id', userId)
                .neq('part_number', 0)
                .order('part_number', { ascending: true });

            playlist.innerHTML = '';
            if(audios && audios.length > 0) {
                audios.forEach(aud => {
                    playlist.innerHTML += `
                        <div class="audio-card shadow-sm">
                            <div class="small fw-bold text-primary mb-1">Step ${aud.part_number}: ${aud.question_text}</div>
                            <div class="d-flex gap-2">
                                ${aud.customer_audio_url ? `<button class="btn btn-sm btn-outline-info" onclick="new Audio('${aud.customer_audio_url}').play()">üîà ‡∏ü‡∏±‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>` : ''}
                                <button class="btn btn-sm btn-success" onclick="new Audio('${aud.audio_url}').play()">üé§ ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                            </div>
                        </div>`;
                });
            } else { playlist.innerHTML = '<div class="alert alert-warning">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏¢‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>'; }
        };

        window.closeModal = () => { document.getElementById('scoringModal').style.display = 'none'; };

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        document.getElementById('saveManualBtn').onclick = async () => {
            const score = document.getElementById('s1').value; // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            const fb = document.getElementById('feedback').value;

            const { error } = await supabase.from('submissions').update({
                manual_score: score,
                feedback: fb
            }).eq('id', currentScoringId);

            if(!error) {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                closeModal();
                fetchSubmissions();
            }
        };

        document.getElementById('filterBtn').onclick = fetchSubmissions;
        document.getElementById('logoutBtn').onclick = () => location.reload();
    </script>
</body>
</html>
