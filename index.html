<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Evaluation Dashboard (Full Feature)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        /* Base Styles คงเดิมตามต้นฉบับของคุณ */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            background-color: #f4f7f6;
            color: #34495e;
            min-height: 100vh;
        }
        #loginPage {
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
        }
        .main-content { display: none; padding: 20px; }
        .table-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .scoring-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        
        /* สไตล์เพิ่มเติมสำหรับรายการเสียง */
        .audio-item { border-left: 4px solid #3498db; background: #f8f9fa; padding: 12px; margin-bottom: 10px; border-radius: 6px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="card shadow-lg p-4" style="width: 400px; border-radius: 15px;">
            <div class="text-center mb-4"><i class="bi bi-person-circle" style="font-size: 3rem; color: #3498db;"></i></div>
            <h3 class="text-center mb-4 fw-bold">Dashboard Login</h3>
            <input type="password" id="adminPass" class="form-control mb-3" placeholder="ระบุรหัสผ่านผู้ดูแล">
            <button id="loginBtn" class="btn btn-primary w-100 fw-bold">เข้าสู่ระบบ</button>
        </div>
    </div>

    <div id="mainContent" class="main-content container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold"><i class="bi bi-speedometer2 text-primary"></i> Simulator Dashboard</h2>
            <button id="logoutBtn" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> ออกจากระบบ</button>
        </div>

        <div class="table-container shadow-sm border">
            <div class="row g-3 mb-4">
                <div class="col-md-3"><label class="small">วันที่เริ่มต้น</label><input type="date" id="startDate" class="form-control"></div>
                <div class="col-md-3"><label class="small">วันที่สิ้นสุด</label><input type="date" id="endDate" class="form-control"></div>
                <div class="col-md-2 d-flex align-items-end"><button id="filterBtn" class="btn btn-success w-100"><i class="bi bi-search"></i> ค้นหา</button></div>
                <div class="col-md-2 d-flex align-items-end"><button id="downloadReportBtn" class="btn btn-info w-100 text-white"><i class="bi bi-file-earmark-arrow-down"></i> รายงาน CSV</button></div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>วัน-เวลา</th>
                            <th>ชื่อพนักงาน</th>
                            <th>หัวข้อ/Step</th>
                            <th>สังกัด</th>
                            <th>ประเภท</th>
                            <th>ฟังเสียง</th>
                            <th>สถานะ</th>
                            <th>การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="submissionTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="scoring-modal">
        <div class="modal-content shadow-lg">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold mb-0">ประเมินผล: <span id="modalTraineeName" class="text-primary"></span></h4>
                <button class="btn-close" onclick="scoringModal.style.display='none'"></button>
            </div>
            <hr>
            
            <div class="row">
                <div class="col-md-5 border-end">
                    <h6 class="fw-bold mb-3"><i class="bi bi-mic-fill text-danger"></i> บันทึกการสนทนาย้อนหลัง</h6>
                    <div id="audioPlaylist" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-muted small">กำลังโหลดรายการเสียง...</p>
                    </div>
                </div>

                <div class="col-md-7 ps-4">
                    <h6 class="fw-bold mb-3"><i class="bi bi-pencil-square text-success"></i> แบบประเมิน</h6>
                    <div class="row g-3">
                        <div class="col-md-4"><label>Step 1 (5)</label><input type="number" id="s1_score" class="form-control" max="5"></div>
                        <div class="col-md-4"><label>Step 2 (5)</label><input type="number" id="s2_score" class="form-control" max="5"></div>
                        <div class="col-md-4"><label>Step 3 (5)</label><input type="number" id="s3_score" class="form-control" max="5"></div>
                        <div class="col-md-4"><label>Step 4 (5)</label><input type="number" id="s4_score" class="form-control" max="5"></div>
                        <div class="col-md-4"><label>Step 5 (5)</label><input type="number" id="s5_score" class="form-control" max="5"></div>
                        <div class="col-md-12"><label>ข้อเสนอแนะเพิ่มเติม</label><textarea id="feedback" class="form-control" rows="4"></textarea></div>
                    </div>
                    <div class="mt-4 p-3 bg-light rounded text-center">
                        <h4 class="mb-0">คะแนนรวม: <span id="totalScoreText" class="text-primary">0</span> / 25</h4>
                    </div>
                    <button id="saveManualScoreBtn" class="btn btn-primary w-100 mt-3 btn-lg fw-bold">บันทึกผลการประเมิน</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Config ต้นฉบับของคุณ ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const VALID_PASS = '12345678';
        let currentScoringId = null;

        // --- ระบบ Login ---
        document.getElementById('loginBtn').onclick = () => {
            if (document.getElementById('adminPass').value === VALID_PASS) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                fetchSubmissions();
            } else { alert('รหัสผ่านไม่ถูกต้อง'); }
        };

        // --- ดึงข้อมูลตารางหลัก ---
        async function fetchSubmissions() {
            let query = supabase.from('submissions').select('*').order('created_at', { ascending: false });
            
            // กรองตามวันที่ถ้ามีการระบุ
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if (start && end) { query = query.gte('created_at', start).lte('created_at', end + 'T23:59:59'); }

            const { data, error } = await query;
            const tbody = document.getElementById('submissionTable');
            tbody.innerHTML = '';

            data.forEach(item => {
                // แสดงเฉพาะ "แถวสรุป" (Part 0) เพื่อไม่ให้ตารางรก แต่ถ้าไม่มีให้โชว์ทุกแถว
                tbody.innerHTML += `
                    <tr>
                        <td class="small">${new Date(item.created_at).toLocaleString('th-TH')}</td>
                        <td class="fw-bold">${item.name}</td>
                        <td><span class="badge bg-light text-dark border">${item.question_text}</span></td>
                        <td>${item.user_group || '-'}</td>
                        <td>${item.insurance_type || '-'}</td>
                        <td><button class="btn btn-sm btn-outline-primary" onclick="window.playAudio('${item.audio_url}')"><i class="bi bi-play-fill"></i> ฟังเสียง</button></td>
                        <td><span class="badge bg-info text-dark">${item.manual_score || 'รอการตรวจ'}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="window.showScoringModal('${item.id}', '${item.name}', '${item.user_id}')">ประเมิน</button></td>
                    </tr>`;
            });
        }

        // --- ระบบเล่นเสียง ---
        window.playAudio = function(url) {
            if(!url) return alert("ไม่พบไฟล์เสียง");
            new Audio(url).play();
        };

        // --- ระบบแสดง Modal และดึงเสียงทุก Step ---
        window.showScoringModal = async function(id, name, userId) {
            currentScoringId = id;
            document.getElementById('modalTraineeName').textContent = name;
            document.getElementById('scoringModal').style.display = 'flex';
            
            const playlist = document.getElementById('audioPlaylist');
            playlist.innerHTML = 'กำลังโหลดไฟล์เสียงทั้งหมด...';

            // ดึงไฟล์เสียงทุก Step ที่มี user_id ตรงกัน
            const { data: audios } = await supabase.from('submissions')
                .select('*')
                .eq('user_id', userId)
                .neq('part_number', 0)
                .order('part_number', { ascending: true });

            playlist.innerHTML = '';
            if(audios && audios.length > 0) {
                audios.forEach(aud => {
                    playlist.innerHTML += `
                        <div class="audio-item">
                            <div class="small fw-bold text-secondary mb-1">Step ${aud.part_number}: ${aud.question_text}</div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success py-0" onclick="window.playAudio('${aud.audio_url}')"><i class="bi bi-mic"></i> ฟังเสียงพนักงาน</button>
                                ${aud.customer_audio_url ? `<button class="btn btn-sm btn-info text-white py-0" onclick="window.playAudio('${aud.customer_audio_url}')"><i class="bi bi-volume-up"></i> ฟังเสียงลูกค้า</button>` : ''}
                            </div>
                        </div>`;
                });
            } else { playlist.innerHTML = '<p class="text-muted">ไม่พบไฟล์เสียงแยกขั้นตอนในระบบ</p>'; }

            // โหลดคะแนนเดิม (ถ้ามี)
            const { data: current } = await supabase.from('submissions').select('*').eq('id', id).single();
            if(current) {
                document.getElementById('s1_score').value = current.s1_score || '';
                document.getElementById('s2_score').value = current.s2_score || '';
                document.getElementById('s3_score').value = current.s3_score || '';
                document.getElementById('s4_score').value = current.s4_score || '';
                document.getElementById('s5_score').value = current.s5_score || '';
                document.getElementById('feedback').value = current.feedback || '';
                calculateTotalScore();
            }
        };

        // --- ระบบคำนวณและบันทึกคะแนน (Logic เดิม) ---
        function calculateTotalScore() {
            const sum = ['s1_score','s2_score','s3_score','s4_score','s5_score'].reduce((acc, id) => acc + (parseInt(document.getElementById(id).value) || 0), 0);
            document.getElementById('totalScoreText').textContent = sum;
        }
        document.querySelectorAll('input[type="number"]').forEach(input => input.oninput = calculateTotalScore);

        document.getElementById('saveManualScoreBtn').onclick = async function() {
            const scoreData = {
                s1_score: parseInt(document.getElementById('s1_score').value),
                s2_score: parseInt(document.getElementById('s2_score').value),
                s3_score: parseInt(document.getElementById('s3_score').value),
                s4_score: parseInt(document.getElementById('s4_score').value),
                s5_score: parseInt(document.getElementById('s5_score').value),
                manual_score: document.getElementById('totalScoreText').textContent,
                feedback: document.getElementById('feedback').value
            };

            const { error } = await supabase.from('submissions').update(scoreData).eq('id', currentScoringId);
            if(!error) { alert("บันทึกคะแนนสำเร็จ"); fetchSubmissions(); document.getElementById('scoringModal').style.display='none'; }
        };

        document.getElementById('filterBtn').onclick = fetchSubmissions;
        document.getElementById('logoutBtn').onclick = () => location.reload();
    </script>
</body>
</html>
