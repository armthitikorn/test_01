<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Evaluation Dashboard (Fixed Filter)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #34495e; }
        .login-card { max-width: 400px; margin: auto; margin-top: 100px; }
        .main-content { display: none; padding: 20px; }
        .table-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .scoring-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        .audio-list-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="loginPage" class="container">
        <div class="card login-card shadow">
            <div class="card-body text-center">
                <h3 class="mb-4">Dashboard Login</h3>
                <input type="password" id="adminPass" class="form-control mb-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•">
                <button id="loginBtn" class="btn btn-primary w-100">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div id="mainContent" class="main-content container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìä Dashboard ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏• Simulator</h2>
            <button id="logoutBtn" class="btn btn-outline-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="table-container">
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label small">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="endDate" class="form-control">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="filterBtn" class="btn btn-success w-100"><i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
                            <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="submissionTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="scoring-modal">
        <div class="modal-content">
            <div class="d-flex justify-content-between">
                <h4>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•: <span id="modalTraineeName" class="text-primary"></span></h4>
                <button onclick="closeModal()" class="btn-close"></button>
            </div>
            <hr>
            
            <div class="mb-4">
                <h6><i class="bi bi-volume-up-fill"></i> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Step 1-5)</h6>
                <div id="audioPlaylist" class="bg-light p-3 rounded border" style="max-height: 300px; overflow-y: auto;">
                    </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (‡πÄ‡∏ï‡πá‡∏° 25)</label>
                    <input type="number" id="manual_score" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
                </div>
                <div class="col-md-12">
                    <label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</label>
                    <textarea id="feedback" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="mt-4 text-end">
                <button id="saveManualBtn" class="btn btn-primary px-5">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        const supabase = createClient(supabaseUrl, supabaseKey);

        let currentScoringId = null;

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Filter ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ---
        async function fetchSubmissions() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            let query = supabase.from('submissions').select('*').eq('part_number', 0); // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ

            if (startDate) query = query.gte('created_at', startDate + 'T00:00:00');
            if (endDate) query = query.lte('created_at', endDate + 'T23:59:59');

            const { data, error } = await query.order('created_at', { ascending: false });

            if (error) return console.error(error);

            const tbody = document.getElementById('submissionTable');
            tbody.innerHTML = data.length === 0 ? '<tr><td colspan="7" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>' : '';

            data.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(item.created_at).toLocaleString('th-TH')}</td>
                        <td>${item.name}</td>
                        <td>${item.user_group || '-'}</td>
                        <td>${item.insurance_type}</td>
                        <td>${item.question_text}</td>
                        <td><span class="badge ${item.manual_score ? 'bg-success' : 'bg-warning'}">${item.manual_score || '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à'}</span></td>
                        <td><button onclick="window.openScoringModal('${item.id}', '${item.name}', '${item.user_id}')" class="btn btn-sm btn-primary">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
                    </tr>`;
            });
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ---
        window.openScoringModal = async (id, name, user_uuid) => {
            currentScoringId = id;
            document.getElementById('modalTraineeName').textContent = name;
            document.getElementById('audioPlaylist').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...';
            
            // ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏∏‡∏Å Step (1-5) ‡∏ó‡∏µ‡πà‡∏°‡∏µ user_id ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
            const { data: audios } = await supabase
                .from('submissions')
                .select('question_text, audio_url, customer_audio_url, part_number')
                .eq('user_id', user_uuid)
                .neq('part_number', 0)
                .order('part_number', { ascending: true });

            const playlist = document.getElementById('audioPlaylist');
            playlist.innerHTML = '';
            
            if(audios.length === 0) playlist.innerHTML = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö';

            audios.forEach(aud => {
                playlist.innerHTML += `
                    <div class="audio-list-item">
                        <div class="flex-grow-1">
                            <div class="small fw-bold">Step ${aud.part_number}: ${aud.question_text}</div>
                            <div class="d-flex gap-2 mt-1">
                                <div class="text-muted small">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</div>
                                <audio controls src="${aud.customer_audio_url}" style="height: 25px;"></audio>
                                <div class="text-muted small ms-2">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</div>
                                <audio controls src="${aud.audio_url}" style="height: 25px;"></audio>
                            </div>
                        </div>
                    </div>`;
            });
            document.getElementById('scoringModal').style.display = 'flex';
        };

        window.closeModal = () => { document.getElementById('scoringModal').style.display = 'none'; };

        const handleLogin = () => {
            if(document.getElementById('adminPass').value === "2456") { // ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                document.getElementById('loginPage').style.display = "none";
                document.getElementById('mainContent').style.display = "block";
                fetchSubmissions(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
        };

        const saveScore = async () => {
            const { error } = await supabase.from('submissions')
                .update({ manual_score: document.getElementById('manual_score').value, feedback: document.getElementById('feedback').value })
                .eq('id', currentScoringId);
            if(!error) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); closeModal(); fetchSubmissions(); }
        };

        document.getElementById('loginBtn').onclick = handleLogin;
        document.getElementById('filterBtn').onclick = fetchSubmissions;
        document.getElementById('saveManualBtn').onclick = saveScore;
        document.getElementById('logoutBtn').onclick = () => location.reload();
    </script>
</body>
</html>
