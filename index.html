<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Evaluation System | Enterprise</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #059669;
            --danger: #dc2626;
            --bg: #f1f5f9;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            height: 100vh;
        }

        /* Sidebar & Sidebar Header */
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #fff;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .user-item {
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: #fff;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .user-item.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .eval-card {
            background: white;
            width: 100%;
            max-width: 900px;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User */
        }

        .part-row {
            display: grid;
            grid-template-columns: 100px 1fr 150px;
            gap: 20px;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .badge {
            background: #e0e7ff;
            color: #4338ca;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
        }

        audio { height: 35px; width: 100%; }

        input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            height: 100px;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            font-family: 'Sarabun';
        }

        .action-bar {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-box {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-excel { background: #10b981; color: white; }
        .btn-excel:hover { background: #059669; }

        .empty-state {
            text-align: center;
            color: var(--secondary);
            margin-top: 100px;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2 style="margin:0; color:var(--primary); font-size: 1.2rem;">Evaluator Panel</h2>
        <p style="font-size: 0.8rem; color: var(--secondary);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
        <button onclick="fetchUsers()" class="btn" style="width:100%; justify-content:center; background:#f1f5f9; color:#444; margin-top:10px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
    </div>
    <div id="userList" class="user-list">
        </div>
</div>

<div class="main-content">
    <div id="emptyState" class="empty-state">
        <img src="https://cdn-icons-png.flaticon.com/512/2040/2040504.png" width="100" style="opacity: 0.2;">
        <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ID ‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
    </div>

    <div id="evalCard" class="eval-card">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
                <h1 id="displayId" style="margin:0; font-size: 1.5rem;">User ID: ---</h1>
                <p id="displayDate" style="color:var(--secondary); font-size: 0.9rem;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: --</p>
            </div>
            <button class="btn btn-excel" onclick="exportToExcel()">üìä Export to Excel</button>
        </div>

        <div style="margin-top:30px;">
            <div id="audioRows">
                </div>
        </div>

        <textarea id="comment" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>

        <div class="action-bar">
            <div class="total-box">
                ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <span id="totalScore">0</span> / 50
            </div>
            <p style="color:var(--secondary); font-size: 0.8rem;">* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        </div>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUserData = { id: '', parts: {} };

    // 1. ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ User ID ‡∏ó‡∏µ‡πà‡∏°‡∏µ Folder
    async function fetchUsers() {
        const listEl = document.getElementById('userList');
        listEl.innerHTML = '<div style="text-align:center; padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
        
        const { data: users, error } = await supabase.storage.from('responses').list('');
        
        listEl.innerHTML = '';
        users.forEach(user => {
            if (user.name === '.emptyFolderPlaceholder') return;
            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `<span>${user.name.substring(0,15)}...</span> <span>‚û°Ô∏è</span>`;
            div.onclick = () => loadUserEvaluation(user.name);
            listEl.appendChild(div);
        });
    }

    // 2. ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á User ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    async function loadUserEvaluation(userId) {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('evalCard').style.display = 'block';
        document.getElementById('displayId').innerText = `User ID: ${userId}`;
        const audioRows = document.getElementById('audioRows');
        audioRows.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á...';
        
        currentUserData = { id: userId, parts: { S1:0, S2:0, S3:0, S4:0, S5:0 }, comment: "" };

        const { data: sections } = await supabase.storage.from('responses').list(userId);
        audioRows.innerHTML = '';

        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ S1-S5 (‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        for (let i = 1; i <= 5; i++) {
            const partName = `S${i}`;
            const { data: files } = await supabase.storage.from('responses').list(`${userId}/${partName}`);
            
            if (files && files.length > 0) {
                const file = files.find(f => f.name.endsWith('.webm'));
                if (file) {
                    const { data: { publicUrl } } = supabase.storage.from('responses').getPublicUrl(`${userId}/${partName}/${file.name}`);
                    appendAudioRow(partName, publicUrl);
                }
            }
        }
        updateTotal();
    }

    function appendAudioRow(part, url) {
        const row = document.createElement('div');
        row.className = 'part-row';
        row.innerHTML = `
            <div class="badge">Part ${part}</div>
            <audio controls src="${url}"></audio>
            <input type="number" min="0" max="10" value="0" 
                oninput="updatePartScore('${part}', this.value)" 
                placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô">
        `;
        document.getElementById('audioRows').appendChild(row);
    }

    // 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    window.updatePartScore = (part, val) => {
        currentUserData.parts[part] = parseInt(val) || 0;
        updateTotal();
    }

    function updateTotal() {
        const total = Object.values(currentUserData.parts).reduce((a, b) => a + b, 0);
        document.getElementById('totalScore').innerText = total;
    }

    // 4. Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel
    window.exportToExcel = () => {
        const comment = document.getElementById('comment').value;
        const data = [{
            "User ID": currentUserData.id,
            "Part 1 (S1)": currentUserData.parts.S1 || 0,
            "Part 2 (S2)": currentUserData.parts.S2 || 0,
            "Part 3 (S3)": currentUserData.parts.S3 || 0,
            "Part 4 (S4)": currentUserData.parts.S4 || 0,
            "Part 5 (S5)": currentUserData.parts.S5 || 0,
            "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°": document.getElementById('totalScore').innerText,
            "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": comment,
            "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô": new Date().toLocaleString('th-TH')
        }];

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Evaluation");
        XLSX.writeFile(wb, `Evaluation_${currentUserData.id.substring(0,8)}.xlsx`);
    };

    window.onload = fetchUsers;
</script>

</body>
</html>
