<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Dashboard - 100% Storage Sync Version</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #34495e; }
        
        #loginPage { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%); }
        .main-content { display: none; padding: 20px; }
        .table-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .scoring-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        
        .audio-step-card { border-left: 5px solid #3498db; background: #f8f9fa; padding: 15px; margin-bottom: 12px; border-radius: 8px; }
        .file-name { font-size: 0.85rem; font-weight: bold; color: #2c3e50; display: block; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="card shadow-lg p-4" style="width: 380px; border-radius: 15px;">
            <h3 class="text-center mb-4 fw-bold">Dashboard Login</h3>
            <input type="password" id="adminPass" class="form-control mb-3" placeholder="ระบุรหัสผ่าน">
            <button id="loginBtn" class="btn btn-primary w-100 fw-bold">เข้าสู่ระบบ</button>
        </div>
    </div>

    <div id="mainContent" class="main-content container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-primary"><i class="bi bi-cloud-check"></i> Simulator Monitoring (Storage Version)</h2>
            <button id="logoutBtn" class="btn btn-danger btn-sm">ออกจากระบบ</button>
        </div>

        <div class="table-container shadow-sm border">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ชื่อพนักงาน</th>
                            <th>สังกัด</th>
                            <th>ประเภทประกัน</th>
                            <th>สถานะการประเมิน</th>
                            <th>การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="submissionTable">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="scoring-modal">
        <div class="modal-content shadow-lg border-0">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold">ประเมินผล: <span id="modalTraineeName" class="text-primary"></span></h4>
                <button class="btn-close" onclick="document.getElementById('scoringModal').style.display='none'"></button>
            </div>
            
            <div class="row">
                <div class="col-md-6 border-end">
                    <h6 class="fw-bold mb-3"><i class="bi bi-hdd-fill text-danger"></i> ตรวจพบไฟล์เสียงใน Storage</h6>
                    <div id="audioPlaylist" style="max-height: 500px; overflow-y: auto;">
                        <p class="text-muted text-center">กำลังเชื่อมต่อกับ Storage...</p>
                    </div>
                </div>

                <div class="col-md-6 ps-4">
                    <h6 class="fw-bold mb-3 text-secondary">บันทึกคะแนน</h6>
                    <div class="row g-2">
                        <div class="col-6"><label class="small">Step 1</label><input type="number" id="s1" class="form-control"></div>
                        <div class="col-6"><label class="small">Step 2</label><input type="number" id="s2" class="form-control"></div>
                        <div class="col-12"><label class="small">ข้อเสนอแนะ</label><textarea id="feedback" class="form-control" rows="3"></textarea></div>
                    </div>
                    <button id="saveScoreBtn" class="btn btn-success w-100 mt-4 fw-bold">บันทึกผลการประเมิน</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Config Supabase ของคุณ ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const VALID_PASS = '12345678';
        let activeUserId = null;

        // Login
        document.getElementById('loginBtn').onclick = () => {
            if (document.getElementById('adminPass').value === VALID_PASS) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                fetchSubmissions();
            } else { alert('รหัสผ่านไม่ถูกต้อง'); }
        };

        // 1. ดึงรายชื่อจากตารางมาโชว์ (Group by User ID)
        async function fetchSubmissions() {
            const { data, error } = await supabase.from('submissions').select('*').order('created_at', { ascending: false });
            if(error) return;

            const grouped = data.reduce((acc, curr) => {
                const key = curr.user_id || curr.userid;
                if (!acc[key]) acc[key] = curr;
                return acc;
            }, {});

            const tbody = document.getElementById('submissionTable');
            tbody.innerHTML = '';
            Object.values(grouped).forEach(item => {
                const uid = item.user_id || item.userid;
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-dark">${item.name}</td>
                        <td>${item.user_group || '-'}</td>
                        <td>${item.insurance_type || '-'}</td>
                        <td><span class="badge ${item.manual_score ? 'bg-success' : 'bg-warning text-dark'}">${item.manual_score || 'รอตรวจ'}</span></td>
                        <td><button class="btn btn-sm btn-primary fw-bold" onclick="window.scanStorageAndOpen('${uid}', '${item.name}')">เปิดดูไฟล์เสียง</button></td>
                    </tr>`;
            });
        }

// --- ฟังก์ชันสแกน Storage แบบเน้นความชัวร์ (ใช้แทนของเดิม) ---
window.scanStorageAndOpen = async (userId, name) => {
    activeUserId = userId;
    document.getElementById('modalTraineeName').textContent = name;
    document.getElementById('scoringModal').style.display = 'flex';
    
    const playlist = document.getElementById('audioPlaylist');
    // โชว์รหัสที่เรากำลังหา ค้างไว้ก่อนเลย ไม่ต้องรีบลบ
    playlist.innerHTML = `
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
            กำลังค้นหาไฟล์ในโฟลเดอร์: <br><b class="text-break">${userId}</b>
        </div>`;

    // 1. สั่ง List รายชื่อไฟล์
    const { data: files, error } = await supabase.storage.from('responses').list(userId, {
        sortBy: { column: 'name', order: 'asc' }
    });

    if (error) {
        playlist.innerHTML = `<div class="alert alert-danger"><b>Error:</b> ${error.message}</div>`;
        return;
    }

    // 2. ถ้าหาไม่เจอ (เป็นสาเหตุที่มันแว๊บหายไปก่อนหน้านี้)
    if (!files || files.length === 0 || (files.length === 1 && files[0].name === '.emptyFolderPlaceholder')) {
        playlist.innerHTML = `
            <div class="alert alert-warning">
                <h6 class="fw-bold"><i class="bi bi-exclamation-triangle"></i> หาโฟลเดอร์ไม่เจอ</h6>
                <p class="small">ระบบหาโฟลเดอร์ชื่อ <code>${userId}</code> ไม่พบใน Storage</p>
                <hr>
                <button class="btn btn-sm btn-outline-dark w-100" onclick="window.scanRootFolder('${userId}')">
                    ลองสแกนหาไฟล์จากหน้าแรก (Root)
                </button>
            </div>`;
        return;
    }

    // 3. ถ้าเจอไฟล์ ให้โชว์ทันที
    playlist.innerHTML = '<h6 class="mb-3 fw-bold text-success">ตรวจพบ ' + files.length + ' ไฟล์:</h6>';
    files.forEach(file => {
        if (file.name === '.emptyFolderPlaceholder') return;

        const { data: { publicUrl } } = supabase.storage.from('responses').getPublicUrl(`${userId}/${file.name}`);

        playlist.innerHTML += `
            <div class="audio-step-card p-3 mb-2 shadow-sm border-start border-4 border-primary bg-white rounded">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold text-dark small">${file.name}</span>
                </div>
                <audio controls src="${publicUrl}" class="w-100" style="height: 35px;"></audio>
            </div>`;
    });
};

// --- ฟังก์ชันเสริม: ในกรณีที่ไฟล์ไม่ได้อยู่ในโฟลเดอร์ แต่อยู่ข้างนอก ---
window.scanRootFolder = async (userId) => {
    const playlist = document.getElementById('audioPlaylist');
    playlist.innerHTML = '<div class="text-center p-3">กำลังสแกนหาไฟล์จากหน้าแรก...</div>';

    const { data: allFiles } = await supabase.storage.from('responses').list('');
    
    // กรองหาไฟล์ที่มีชื่อ userId อยู่ข้างใน
    const matchedFiles = allFiles.filter(f => f.name.includes(userId));

    if (matchedFiles.length === 0) {
        playlist.innerHTML = '<div class="alert alert-danger">ไม่พบไฟล์ที่มีชื่อเกี่ยวข้องกับรหัสนี้เลยใน Storage</div>';
        return;
    }

    playlist.innerHTML = '<h6 class="mb-3 fw-bold text-info">พบไฟล์จากหน้าแรก:</h6>';
    matchedFiles.forEach(file => {
        const { data: { publicUrl } } = supabase.storage.from('responses').getPublicUrl(file.name);
        playlist.innerHTML += `
            <div class="audio-step-card p-3 mb-2 shadow-sm border-start border-4 border-info bg-white rounded">
                <span class="file-name small fw-bold">${file.name}</span>
                <audio controls src="${publicUrl}" class="w-100 mt-2" style="height: 35px;"></audio>
            </div>`;
    });
};
        // บันทึกคะแนน
        document.getElementById('saveScoreBtn').onclick = async () => {
            const { error } = await supabase.from('submissions')
                .update({ manual_score: "ประเมินแล้ว", feedback: document.getElementById('feedback').value })
                .match({ user_id: activeUserId });

            if(!error) { alert("บันทึกสำเร็จ"); fetchSubmissions(); document.getElementById('scoringModal').style.display='none'; }
        };

        document.getElementById('logoutBtn').onclick = () => location.reload();
    </script>
</body>
</html>
