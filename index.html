<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Dashboard - Storage Direct Access Version</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; }
        .main-content { display: none; padding: 20px; }
        .table-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .scoring-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1050; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        .audio-card { border-left: 5px solid #007bff; background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="loginPage" class="container text-center" style="margin-top: 100px;">
        <div class="card shadow-lg p-4 m-auto" style="max-width: 400px;">
            <h3 class="mb-4">Dashboard Login</h3>
            <input type="password" id="adminPass" class="form-control mb-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="loginBtn" class="btn btn-primary w-100">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="mainContent" class="main-content container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏• Simulator</h2>
            <button id="logoutBtn" class="btn btn-danger btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="submissionTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="scoring-modal">
        <div class="modal-content shadow-lg">
            <div class="d-flex justify-content-between mb-4">
                <h4><i class="bi bi-mic-fill text-danger"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="modalTraineeName"></span></h4>
                <button class="btn-close" onclick="document.getElementById('scoringModal').style.display='none'"></button>
            </div>
            
            <div class="row">
                <div class="col-md-6 border-end">
                    <h6 class="fw-bold mb-3">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÉ‡∏ô Storage (S1-S5)</h6>
                    <div id="audioPlaylist" style="max-height: 450px; overflow-y: auto;">
                        <p class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå...</p>
                    </div>
                </div>

                <div class="col-md-6 ps-4">
                    <h6>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h6>
                    <div class="row g-2">
                        <div class="col-6"><label>Step 1</label><input type="number" id="s1" class="form-control"></div>
                        <div class="col-6"><label>Step 2</label><input type="number" id="s2" class="form-control"></div>
                        <div class="col-12"><label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</label><textarea id="feedback" class="form-control" rows="3"></textarea></div>
                    </div>
                    <button id="saveScoreBtn" class="btn btn-success w-100 mt-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Config Supabase ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        const supabase = createClient(supabaseUrl, supabaseKey);

        let currentUserIdActive = "";

        // Login Logic
        document.getElementById('loginBtn').onclick = () => {
            if(document.getElementById('adminPass').value === "12345678") {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                fetchSubmissions();
            } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î"); }
        };

        // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        async function fetchSubmissions() {
            const { data } = await supabase.from('submissions').select('*').order('created_at', {ascending: false});
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥
            const grouped = data.reduce((acc, curr) => {
                const key = curr.user_id || curr.userid;
                if (!acc[key]) acc[key] = curr;
                return acc;
            }, {});

            const tbody = document.getElementById('submissionTable');
            tbody.innerHTML = '';
            Object.values(grouped).forEach(item => {
                const uid = item.user_id || item.userid;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.user_group || '-'}</td>
                        <td>${item.insurance_type || '-'}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="window.scanAndOpen('${uid}', '${item.name}')">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button></td>
                    </tr>`;
            });
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà": ‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Storage ‡∏ï‡∏£‡∏á‡πÜ ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏≠‡πà‡∏≤‡∏ô URL ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        window.scanAndOpen = async (userId, name) => {
            currentUserIdActive = userId;
            document.getElementById('modalTraineeName').textContent = name;
            document.getElementById('scoringModal').style.display = 'flex';
            
            const playlist = document.getElementById('audioPlaylist');
            playlist.innerHTML = 'üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô Storage...';

            // --- ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Storage ---
            const { data: files, error } = await supabase.storage.from('responses').list(userId, {
                limit: 100,
                sortBy: { column: 'name', order: 'asc' }
            });

            if (error || !files || files.length === 0) {
                playlist.innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô Storage ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ';
                return;
            }

            playlist.innerHTML = '';
            files.forEach(file => {
                if(file.name.includes('.empty')) return;

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏£‡∏á‡πÜ ‡∏à‡∏≤‡∏Å Storage
                const { data: { publicUrl } } = supabase.storage.from('responses').getPublicUrl(`${userId}/${file.name}`);

                playlist.innerHTML += `
                    <div class="audio-card shadow-sm">
                        <div class="fw-bold text-primary mb-2">‡πÑ‡∏ü‡∏•‡πå: ${file.name}</div>
                        <audio controls src="${publicUrl}" class="w-100"></audio>
                    </div>`;
            });
        };

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        document.getElementById('saveScoreBtn').onclick = async () => {
            const { error } = await supabase.from('submissions')
                .update({ 
                    manual_score: "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß", 
                    feedback: document.getElementById('feedback').value 
                })
                .match({ user_id: currentUserIdActive });

            if(!error) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); fetchSubmissions(); document.getElementById('scoringModal').style.display='none'; }
        };

        document.getElementById('logoutBtn').onclick = () => location.reload();
    </script>
</body>
</html>
