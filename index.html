<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Audio Storage Explorer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; padding: 30px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .status-box { padding: 10px; margin-bottom: 20px; border-radius: 5px; text-align: center; font-weight: bold; }
        .loading { background: #fff3cd; color: #856404; }
        .ready { background: #d4edda; color: #155724; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #007bff; color: white; }
        tr:hover { background-color: #f1f1f1; }
        audio { height: 35px; width: 200px; }
        .btn-refresh { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; float: right; }
        .user-badge { background: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; }
        .part-badge { background: #17a2b8; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-refresh" onclick="scanStorage()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <h1>üìÇ Audio Storage Explorer</h1>
    
    <div id="status" class="status-box loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>

    <table id="fileTable">
        <thead>
            <tr>
                <th>User ID</th>
                <th>Section</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå</th>
                <th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á</th>
                <th>‡∏•‡∏¥‡∏á‡∏Å‡πå</th>
            </tr>
        </thead>
        <tbody id="fileList">
            </tbody>
    </table>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Config ‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function scanStorage() {
        const statusEl = document.getElementById('status');
        const listEl = document.getElementById('fileList');
        
        statusEl.className = 'status-box loading';
        statusEl.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô Storage... (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)';
        listEl.innerHTML = '';

        try {
            // 1. ‡∏î‡∏∂‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ö‡∏ô‡∏™‡∏∏‡∏î (User IDs)
            const { data: users, error: userError } = await supabase.storage.from('responses').list('');
            if (userError) throw userError;

            let fileCount = 0;

            for (const user of users) {
                if (user.name === '.emptyFolderPlaceholder') continue;

                // 2. ‡∏î‡∏∂‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Section (S1, S2, S3...) ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô User
                const { data: sections, error: sectionError } = await supabase.storage.from('responses').list(user.name);
                if (sectionError) continue;

                for (const section of sections) {
                    // 3. ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå .webm ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Section
                    const path = `${user.name}/${section.name}`;
                    const { data: files, error: fileError } = await supabase.storage.from('responses').list(path);
                    if (fileError) continue;

                    for (const file of files) {
                        if (file.name.endsWith('.webm')) {
                            fileCount++;
                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Public URL
                            const { data: { publicUrl } } = supabase.storage.from('responses').getPublicUrl(`${path}/${file.name}`);
                            
                            appendRow(user.name, section.name, file.name, publicUrl);
                        }
                    }
                }
            }

            statusEl.className = 'status-box ready';
            statusEl.textContent = `‚úÖ ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${fileCount} ‡πÑ‡∏ü‡∏•‡πå`;
            
            if(fileCount === 0) {
                listEl.innerHTML = '<tr><td colspan="5" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
            }

        } catch (err) {
            statusEl.className = 'status-box';
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
        }
    }

    function appendRow(userId, section, fileName, url) {
        const listEl = document.getElementById('fileList');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span class="user-badge">${userId.substring(0,8)}...</span></td>
            <td><span class="part-badge">${section}</span></td>
            <td style="font-size: 0.85em; color: #666;">${fileName}</td>
            <td><audio controls src="${url}"></audio></td>
            <td><a href="${url}" target="_blank">üîó ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå</a></td>
        `;
        listEl.appendChild(row);
    }

    // ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    window.scanStorage = scanStorage;
    window.onload = scanStorage;

</script>

</body>
</html>
