<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>E-Simulator Roleplay (Final Fixed)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
            -webkit-text-size-adjust: 100%;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        h1 { font-size: 28px; color: #d9534f; margin-bottom: 20px; }
        h2 { margin-top: 25px; font-size: 22px; color: #337ab7; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        button {
            padding: 12px 24px;
            font-size: 18px;
            cursor: pointer;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 8px;
            margin: 10px;
            transition: all 0.3s ease;
            font-family: 'Sarabun', sans-serif;
            font-weight: bold;
        }
        button:hover { background-color: #4cae4c; transform: translateY(-2px); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-stop { background-color: #d9534f; }
        .btn-stop:hover { background-color: #c9302c; }
        .btn-next { background-color: #f0ad4e; }
        
        .setup-section, .test-section { margin-bottom: 30px; text-align: left; }
        .instruction { font-size: 16px; color: #666; margin-bottom: 15px; line-height: 1.6; }
        .status-recording { color: #d9534f; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity:1;} 50% {opacity:0.4;} 100% {opacity:1;} }
        
        input[type="text"], select {
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;
        }
        .radio-group { display: flex; gap: 20px; margin: 10px 0; }
        
        #certificate {
            display: none; margin-top: 30px; padding: 40px; border: 10px double #d9534f; background: #fff; position: relative;
        }
        #certificate h2 { border: none; color: #d9534f; font-size: 32px; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #d9534f;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingText" style="margin-top:15px; font-weight:bold;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div class="container-box">
        <h1>üéôÔ∏è Sales E-Simulator</h1>
        
        <div id="setup" class="setup-section">
            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
            <input type="text" id="inputUserName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            <label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î/‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô:</label>
            <input type="text" id="inputUserGroup" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô">
            
            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label>
            <div class="radio-group">
                <label><input type="radio" name="difficulty" value="easy" checked> ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (Easy)</label>
                <label><input type="radio" name="difficulty" value="hard"> ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ (Hard)</label>
            </div>
            
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô:</label>
            <select id="productType">
                <option value="CI">CI Super Care</option>
                <option value="Life">Life Care 20/99</option>
            </select>
            <button id="startTestBtn" style="width:100%; margin:20px 0;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>

        <div id="section1" class="test-section" style="display:none;">
            <h2>Step 1: ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®</h2>
            <p class="instruction" id="s1_instruction"></p>
            <audio id="customerAudio" style="width:100%; margin-bottom:10px;"></audio>
            <div id="s1_status"></div>
            <button id="recordBtn">üé§ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ</button>
            <button id="nextRoundBtn" class="btn-next" style="display:none;">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            <button id="nextSection2Btn" class="btn-next" style="display:none;">‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <div id="section2" class="test-section" style="display:none;">
            <h2>Step 2: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (Pitching)</h2>
            <p class="instruction">‡πÇ‡∏õ‡∏£‡∏î‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
            <div id="s2_status"></div>
            <button id="pitchRecordBtn">üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
            <button id="nextSection3Btn" class="btn-next" style="display:none;">‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <div id="section3" class="test-section" style="display:none;">
            <h2>Step 3: ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</h2>
            <p class="instruction">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏á‡∏™‡∏±‡∏¢... ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <button id="startQBtn">üîà ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            <div id="s3_status" style="margin-top:10px;"></div>
            <button id="answerBtn" style="display:none;">üé§ ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
            <button id="closeBtn" style="display:none;">üé§ ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
            <button id="replyBtn" style="display:none;">üé§ ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
            <button id="nextSection4Btn" class="btn-next" style="display:none;">‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <div id="section4" class="test-section" style="display:none;">
            <h2>Step 4: ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á</h2>
            <p class="instruction">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏•‡∏±‡∏á‡πÄ‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô...</p>
            <div id="s4_status"></div>
            <button id="answerHBtn">üé§ ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</button>
            <button id="nextSection5Btn" class="btn-next" style="display:none;">‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</button>
        </div>

        <div id="section5" class="test-section" style="display:none;">
            <h2>Step 5: ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
            <p class="instruction">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏≥‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <div id="s5_status"></div>
            <button id="answerABtn">üé§ ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
            <button id="finalSaveBtn" class="btn-next" style="display:none; background-color: #28a745;">‚úÖ ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>

        <div id="certificate">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</h2>
            <p style="font-size: 20px;">‡∏Ñ‡∏∏‡∏ì <strong><span id="traineeName"></span></strong></p>
            <p>‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Sales E-Simulator ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
            <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö: <span id="issueDate"></span></p>
            <button id="certBtn" style="background:#d9534f;">‡∏î‡∏π‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    const supabase = createClient(supabaseUrl, supabaseKey);

    // --- 1. ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ---
    const scenarios = {
        s1: [
            { text: "‡πÇ‡∏ó‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö? / ‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏Ñ‡∏£‡∏±‡∏ö ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏•‡πâ‡∏ß", audio: "audio/s1_1.mp3" },
            { text: "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ñ‡∏∏‡∏¢ ‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?", audio: "audio/s1_2.mp3" },
            { text: "‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö? / ‡πÑ‡∏°‡πà‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?", audio: "audio/s1_3.mp3" }
        ],
        s2: [
            { text: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡∏µ‡πà‡∏õ‡∏µ? ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Å‡∏µ‡πà‡∏õ‡∏µ? ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà/‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏/OPD ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?", audio: "audio/s2_1.mp3" }
        ],
        s3: [
            { text: "‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏£‡∏Ñ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?", audio: "audio/s3_1.mp3" }
        ],
        s4: [
            { text: "‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà? ‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á‡πÑ‡∏´‡∏°? ‡∏ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á?", audio: "audio/s4_1.mp3" }
        ],
        s5: [
            { text: "‡∏Ç‡∏≠‡∏Ñ‡∏¥‡∏î‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô / ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏ü‡∏ô‡∏Å‡πà‡∏≠‡∏ô / ‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÅ‡∏û‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ", audio: "audio/s5_1.mp3" }
        ]
    };

    let mediaRecorder;
    let audioChunks = [];
    let allRecordings = [];
    let currentUserId = uuidv4();
    let selectedProductType = "";
    let s1_round = 0;
    const customerAudioPlayer = new Audio();

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    const playScenarioAudio = (audioUrl, statusId) => {
        const statusElem = document.getElementById(statusId);
        statusElem.innerHTML = "üîà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...";
        customerAudioPlayer.src = audioUrl;
        customerAudioPlayer.play();
        customerAudioPlayer.onended = () => {
            statusElem.innerHTML = "‚úÖ ‡∏ü‡∏±‡∏á‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢";
        };
    };

    // --- Section 1: ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à (Loop ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠) ---
    const startTest = () => {
        const name = document.getElementById("inputUserName").value;
        if(!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°");
        selectedProductType = document.getElementById("productType").value;
        document.getElementById("setup").style.display = "none";
        document.getElementById("section1").style.display = "block";
        loadS1Round();
    };

    const loadS1Round = () => {
        if(s1_round < scenarios.s1.length) {
            const currentQ = scenarios.s1[s1_round];
            document.getElementById("s1_instruction").textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà ${s1_round + 1}: ${currentQ.text}`;
            document.getElementById("nextRoundBtn").style.display = "none";
            document.getElementById("recordBtn").style.display = "none"; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏π‡∏î‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏î‡∏ü‡∏±‡∏á
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°
            let playBtn = document.getElementById("playS1Btn");
            if(!playBtn) {
                playBtn = document.createElement("button");
                playBtn.id = "playS1Btn";
                playBtn.textContent = "üîà ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
                playBtn.onclick = () => {
                    playScenarioAudio(currentQ.audio, "s1_status");
                    document.getElementById("recordBtn").style.display = "inline-block";
                };
                document.getElementById("section1").insertBefore(playBtn, document.getElementById("s1_status"));
            }
        } else {
            document.getElementById("section1").innerHTML = "<h2>‡∏à‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1</h2><button class='btn-next' onclick='document.getElementById(\"section1\").style.display=\"none\"; document.getElementById(\"section2\").style.display=\"block\";'>‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2</button>";
        }
    };

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å Section) ---
    const toggleRecording = async (step, sectionKey, roundIdx) => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            return;
        }
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
            let qText = scenarios[sectionKey][roundIdx].text;
            let partNum = parseInt(step);

            allRecordings.push({ 
                part: partNum, 
                qNum: roundIdx + 1, 
                qText: qText, 
                audioBlob: blob 
            });

            updateUIStatus(step, false);
            showNextButton(step);
        };
        mediaRecorder.start();
        updateUIStatus(step, true);
    };

    const updateUIStatus = (step, isRecording) => {
        const statusMap = {1:"s1_status", 8:"s2_status", 2:"s3_status", 5:"s4_status", 6:"s5_status"};
        const statusId = statusMap[step];
        document.getElementById(statusId).innerHTML = isRecording ? 
            '<p class="status-recording">üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>' : 
            '<p style="color:green;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';
    };

    const showNextButton = (step) => {
        if(step === 1) { 
            s1_round++; 
            document.getElementById("nextRoundBtn").style.display = "inline-block"; 
            document.getElementById("recordBtn").style.display = "none";
        }
        else if(step === 8) document.getElementById("nextSection3Btn").style.display = "inline-block";
        else if(step === 2) document.getElementById("nextSection4Btn").style.display = "inline-block";
        else if(step === 5) document.getElementById("nextSection5Btn").style.display = "inline-block";
        else if(step === 6) document.getElementById("finalSaveBtn").style.display = "inline-block";
    };

    // --- ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---

    // Section 1
    document.getElementById("startTestBtn").onclick = startTest;
    document.getElementById("recordBtn").onclick = () => toggleRecording(1, 's1', s1_round);
    document.getElementById("nextRoundBtn").onclick = loadS1Round;

    // Section 2: Pitching
    document.getElementById("pitchRecordBtn").parentElement.querySelector('p').textContent = scenarios.s2[0].text;
    document.getElementById("pitchRecordBtn").onclick = () => toggleRecording(8, 's2', 0);

    // Section 3: Health (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    document.getElementById("startQBtn").onclick = () => {
        playScenarioAudio(scenarios.s3[0].audio, "s3_status");
        document.getElementById("answerBtn").style.display = "inline-block";
    };
    document.getElementById("answerBtn").onclick = () => toggleRecording(2, 's3', 0);

    // Section 4: Premium
    document.getElementById("answerHBtn").onclick = () => {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ô HTML ‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∞‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö
        toggleRecording(5, 's4', 0);
    };

    // Section 5: Closing
    document.getElementById("answerABtn").onclick = () => toggleRecording(6, 's5', 0);

    // Final Save
    document.getElementById("finalSaveBtn").onclick = async () => {
        // ... (‡πÉ‡∏ä‡πâ logic uploadAll ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å allRecordings ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    };

</script>
</body>
</html>
