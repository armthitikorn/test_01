<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Evaluation Dashboard (Integrated)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            background-color: #f4f7f6;
            color: #34495e;
        }
        /* ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
        .login-card { max-width: 400px; margin: auto; margin-top: 100px; }
        .main-content { display: none; padding: 20px; }
        .table-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .scoring-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .audio-list-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="loginPage" class="container">
        <div class="card login-card shadow">
            <div class="card-body">
                <h3 class="text-center mb-4">Dashboard Login</h3>
                <input type="password" id="adminPass" class="form-control mb-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•">
                <button id="loginBtn" class="btn btn-primary w-100">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div id="mainContent" class="main-content container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Simulator</h2>
            <button id="logoutBtn" class="btn btn-outline-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="table-container">
            <div class="row g-3 mb-4">
                <div class="col-md-3"><input type="date" id="startDate" class="form-control"></div>
                <div class="col-md-3"><input type="date" id="endDate" class="form-control"></div>
                <div class="col-md-2"><button id="filterBtn" class="btn btn-success w-100">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button></div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
                            <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</th>
                            <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="submissionTable">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="scoring-modal">
        <div class="modal-content">
            <h4>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•: <span id="modalTraineeName" class="text-primary"></span></h4>
            <hr>
            
            <div class="mb-4">
                <h6>‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</h6>
                <div id="audioPlaylist" class="bg-light p-3 rounded border" style="max-height: 250px; overflow-y: auto;">
                    </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Step 1 (5)</label>
                    <input type="number" id="s1_score" class="form-control score-input" max="5">
                </div>
                <div class="col-md-4">
                    <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Step 2 (5)</label>
                    <input type="number" id="s2_score" class="form-control score-input" max="5">
                </div>
                <div class="col-md-12">
                    <label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="feedback" class="form-control" rows="3"></textarea>
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <button onclick="closeModal()" class="btn btn-secondary">‡∏õ‡∏¥‡∏î</button>
                <button id="saveManualBtn" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Config Supabase (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        const supabase = createClient(supabaseUrl, supabaseKey);

        let currentScoringId = null;
        let currentUserUUID = null;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Login
        const handleLogin = () => {
            if(document.getElementById('adminPass').value === "1234") { // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                document.getElementById('loginPage').style.display = "none";
                document.getElementById('mainContent').style.display = "block";
                fetchSubmissions();
            } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
        };

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ Part 0) ---
        async function fetchSubmissions() {
            const { data, error } = await supabase
                .from('submissions')
                .select('*')
                .eq('part_number', 0) // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡πÅ‡∏ñ‡∏ß‡∏´‡∏•‡∏±‡∏Å" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏Å
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('submissionTable');
            tbody.innerHTML = '';

            data.forEach(item => {
                const row = `<tr>
                    <td>${new Date(item.created_at).toLocaleDateString('th-TH')}</td>
                    <td>${item.name}</td>
                    <td>${item.user_group || '-'}</td>
                    <td>${item.insurance_type}</td>
                    <td>${item.question_text}</td>
                    <td><span class="badge bg-info text-dark">${item.manual_score || '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à'}</span></td>
                    <td><button onclick="openScoringModal('${item.id}', '${item.name}', '${item.user_id}')" class="btn btn-sm btn-primary">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
        window.openScoringModal = async (id, name, user_uuid) => {
            currentScoringId = id;
            currentUserUUID = user_uuid;
            document.getElementById('modalTraineeName').textContent = name;
            
            // ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Step 1-5) ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
            const { data: audios } = await supabase
                .from('submissions')
                .select('question_text, audio_url, part_number')
                .eq('user_id', user_uuid)
                .neq('part_number', 0)
                .order('part_number', { ascending: true });

            const playlist = document.getElementById('audioPlaylist');
            playlist.innerHTML = '';
            
            audios.forEach(aud => {
                playlist.innerHTML += `
                    <div class="audio-list-item">
                        <span class="small"><b>Step ${aud.part_number}:</b> ${aud.question_text}</span>
                        <audio controls src="${aud.audio_url}" style="height: 30px; width: 200px;"></audio>
                    </div>`;
            });

            document.getElementById('scoringModal').style.display = 'flex';
        };

        window.closeModal = () => { document.getElementById('scoringModal').style.display = 'none'; };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        const saveScore = async () => {
            const score = document.getElementById('s1_score').value; // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            const { error } = await supabase
                .from('submissions')
                .update({ manual_score: score, feedback: document.getElementById('feedback').value })
                .eq('id', currentScoringId);

            if(!error) {
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                closeModal();
                fetchSubmissions();
            }
        };

        document.getElementById('loginBtn').onclick = handleLogin;
        document.getElementById('saveManualBtn').onclick = saveScore;
        document.getElementById('logoutBtn').onclick = () => location.reload();
        document.getElementById('filterBtn').onclick = fetchSubmissions;
    </script>
</body>
</html>
