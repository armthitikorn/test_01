<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Professional Simulator Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; color: #1c1e21; }
        
        /* Sidebar & Layout */
        .navbar-brand { font-weight: 700; letter-spacing: 1px; }
        .main-content { display: none; padding: 30px; }
        
        /* KPI Cards */
        .kpi-card { background: white; border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: 0.3s; }
        .kpi-card:hover { transform: translateY(-5px); }
        .icon-box { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        
        /* Filter Section */
        .filter-section { background: white; border-radius: 15px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        
        /* Table Style */
        .table-container { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .table thead { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        
        /* Audio Modal Custom */
        .audio-step-card { border: 1px solid #e1e4e8; background: #ffffff; padding: 15px; margin-bottom: 15px; border-radius: 12px; transition: 0.2s; }
        .audio-step-card:hover { border-color: #3498db; background: #fcfdfe; }
        .scoring-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 35px; border-radius: 25px; width: 95%; max-width: 1000px; max-height: 90vh; overflow-y: auto; }
        
        #loginPage { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #2c3e50; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="card shadow-lg p-4" style="width: 400px; border-radius: 20px; border: none;">
            <div class="text-center mb-4">
                <div class="bg-primary text-white mx-auto mb-3 icon-box"><i class="bi bi-lock-fill"></i></div>
                <h4 class="fw-bold">Admin Access</h4>
                <p class="text-muted small">Simulator Management System</p>
            </div>
            <input type="password" id="adminPass" class="form-control mb-3 py-2" placeholder="กรุณาใส่รหัสผ่าน">
            <button id="loginBtn" class="btn btn-primary w-100 py-2 fw-bold rounded-pill">ยืนยันตัวตน</button>
        </div>
    </div>

    <div id="mainContent" class="main-content container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark mb-0">Dashboard ประเมินผล</h2>
                <p class="text-muted">ระบบติดตามและตรวจสอบการฝึกปฏิบัติ Simulator</p>
            </div>
            <div class="d-flex gap-2">
                <button id="exportCsvBtn" class="btn btn-outline-success fw-bold"><i class="bi bi-file-earmark-excel"></i> ส่งออกรายงาน</button>
                <button id="logoutBtn" class="btn btn-danger"><i class="bi bi-box-arrow-right"></i> ออกจากระบบ</button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-primary-subtle text-primary me-3"><i class="bi bi-people"></i></div>
                        <div><small class="text-muted">ทั้งหมด</small><h4 class="fw-bold mb-0" id="statTotal">0</h4></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-success-subtle text-success me-3"><i class="bi bi-check-circle"></i></div>
                        <div><small class="text-muted">ประเมินแล้ว</small><h4 class="fw-bold mb-0" id="statDone">0</h4></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-warning-subtle text-warning me-3"><i class="bi bi-clock-history"></i></div>
                        <div><small class="text-muted">รอประเมิน</small><h4 class="fw-bold mb-0" id="statPending">0</h4></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-info-subtle text-info me-3"><i class="bi bi-mic"></i></div>
                        <div><small class="text-muted">ไฟล์เสียงรวม</small><h4 class="fw-bold mb-0" id="statAudio">0</h4></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-section border">
            <h6 class="fw-bold mb-3"><i class="bi bi-funnel-fill"></i> ตัวกรองข้อมูลแบบละเอียด</h6>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="small fw-bold">จากวันที่</label>
                    <input type="date" id="filterStart" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold">ถึงวันที่</label>
                    <input type="date" id="filterEnd" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold">แผนก/กลุ่ม</label>
                    <select id="filterGroup" class="form-select">
                        <option value="">ทั้งหมด</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold">ระดับพนักงาน</label>
                    <select id="filterLevel" class="form-select">
                        <option value="">ทั้งหมด</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="applyFilters" class="btn btn-primary w-100 fw-bold shadow-sm">ค้นหาข้อมูล</button>
                </div>
            </div>
        </div>

        <div class="table-container shadow-sm border">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>พนักงาน</th>
                            <th>ข้อมูลกลุ่ม/ระดับ</th>
                            <th>วัน-เวลาที่ส่ง</th>
                            <th>สถานะประเมิน</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="submissionTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="scoring-modal">
        <div class="modal-content shadow-lg border-0">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                <h4 class="fw-bold mb-0 text-dark"><i class="bi bi-headphones"></i> ประเมินผล: <span id="modalTraineeName" class="text-primary"></span></h4>
                <button class="btn-close" onclick="document.getElementById('scoringModal').style.display='none'"></button>
            </div>
            
            <div class="row">
                <div class="col-md-5 border-end">
                    <h6 class="fw-bold mb-3 text-secondary"><i class="bi bi-list-stars"></i> คิวไฟล์เสียงฝึกปฏิบัติ</h6>
                    <div id="audioPlaylist" style="max-height: 500px; overflow-y: auto; padding-right: 15px;"></div>
                </div>

                <div class="col-md-7 ps-4">
                    <h6 class="fw-bold mb-3 text-secondary"><i class="bi bi-pencil-square"></i> บันทึกเกณฑ์คะแนน</h6>
                    <div class="row g-3 bg-light p-3 rounded-4 mb-3">
                        <div class="col-4"><label class="small fw-bold">S1</label><input type="number" id="s1" class="form-control score-input" max="5"></div>
                        <div class="col-4"><label class="small fw-bold">S1.5</label><input type="number" id="s1_5" class="form-control score-input" max="5"></div>
                        <div class="col-4"><label class="small fw-bold">S2</label><input type="number" id="s2" class="form-control score-input" max="5"></div>
                        <div class="col-4"><label class="small fw-bold">S3</label><input type="number" id="s3" class="form-control score-input" max="5"></div>
                        <div class="col-4"><label class="small fw-bold">S4</label><input type="number" id="s4" class="form-control score-input" max="5"></div>
                        <div class="col-4"><label class="small fw-bold">S5</label><input type="number" id="s5" class="form-control score-input" max="5"></div>
                        <div class="col-12"><label class="small fw-bold">ความเห็นผู้ประเมิน</label><textarea id="feedback" class="form-control" rows="3" placeholder="ระบุข้อเสนอแนะเพื่อให้พนักงานพัฒนาต่อ..."></textarea></div>
                    </div>
                    <div class="bg-primary text-white p-3 rounded-4 text-center shadow">
                        <h4 class="mb-0 fw-bold">คะแนนรวม: <span id="totalScoreText">0</span> / 30</h4>
                    </div>
                    <button id="saveScoreBtn" class="btn btn-success w-100 mt-4 btn-lg fw-bold rounded-pill shadow">บันทึกและปิดงานประเมิน</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Config Supabase ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        const supabase = createClient(supabaseUrl, supabaseKey);

        let activeUserId = null;
        let allSubmissions = [];

        // Login Logic
        document.getElementById('loginBtn').onclick = () => {
            if (document.getElementById('adminPass').value === "12345678") {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                fetchSubmissions();
            } else { alert('รหัสผ่านไม่ถูกต้อง'); }
        };

        // 1. ดึงข้อมูลพนักงานพร้อมระบบ Filter
        async function fetchSubmissions() {
            let query = supabase.from('submissions').select('*').order('created_at', { ascending: false });

            // ดึงค่าจาก Filters
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            const group = document.getElementById('filterGroup').value;
            const level = document.getElementById('filterLevel').value;

            if (start) query = query.gte('created_at', start);
            if (end) query = query.lte('created_at', end + 'T23:59:59');
            if (group) query = query.eq('user_group', group);
            if (level) query = query.eq('staff_level', level); // ตรวจสอบชื่อคอลัมน์ใน DB ให้ตรงกัน

            const { data, error } = await query;
            if (error) return;

            allSubmissions = data;
            renderDashboard(data);
            populateFilterOptions(data);
        }

        // 2. แสดงผล Dashboard และ KPI
        function renderDashboard(data) {
            // จัดกลุ่มพนักงาน
            const grouped = data.reduce((acc, curr) => {
                const key = curr.user_id || curr.userid;
                if (!acc[key]) acc[key] = curr;
                return acc;
            }, {});

            const submissions = Object.values(grouped);
            
            // อัปเดต KPI
            document.getElementById('statTotal').innerText = submissions.length;
            document.getElementById('statDone').innerText = submissions.filter(s => s.manual_score).length;
            document.getElementById('statPending').innerText = submissions.filter(s => !s.manual_score).length;

            const tbody = document.getElementById('submissionTable');
            tbody.innerHTML = '';
            
            submissions.forEach(item => {
                const uid = item.user_id || item.userid;
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="fw-bold">${item.name}</div>
                            <div class="text-muted small">ID: ${uid.substring(0,8)}...</div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">${item.user_group || 'ทั่วไป'}</span><br>
                            <small class="text-muted">${item.staff_level || 'ระดับ 1'}</small>
                        </td>
                        <td class="small">${new Date(item.created_at).toLocaleString('th-TH')}</td>
                        <td>
                            <span class="badge rounded-pill ${item.manual_score ? 'bg-success' : 'bg-warning text-dark'}">
                                ${item.manual_score ? 'ประเมินแล้ว: ' + item.manual_score : 'รอตรวจ'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary px-3 rounded-pill" onclick="window.scanDeepStorage('${uid}', '${item.name}')">
                                <i class="bi bi-search"></i> ตรวจงาน
                            </button>
                        </td>
                    </tr>`;
            });
        }

        // 3. ฟังก์ชันดึงไฟล์เสียง (Deep Scan จาก URL ที่ถูกต้อง)
        window.scanDeepStorage = async (userId, name) => {
            activeUserId = userId;
            document.getElementById('modalTraineeName').textContent = name;
            document.getElementById('scoringModal').style.display = 'flex';
            
            const playlist = document.getElementById('audioPlaylist');
            playlist.innerHTML = `<div class="p-3 border rounded-4 bg-light mb-3">
                <small class="text-muted">กำลังตรวจสอบโฟลเดอร์รหัส:</small><br>
                <code class="text-danger small">${userId}</code>
                <div id="loader" class="mt-2 small text-primary"><div class="spinner-border spinner-border-sm"></div> กำลังมุดหาไฟล์ S1-S5...</div>
            </div>`;

            const subFolders = ['S1', 'S1.5', 'S2', 'S3', 'S4', 'S5'];
            let foundCount = 0;

            for (const folder of subFolders) {
                const path = `${userId}/${folder}`;
                const { data: files, error } = await supabase.storage.from('responses').list(path);

                if (!error && files && files.length > 0) {
                    files.forEach(file => {
                        if (file.name.includes('.empty')) return;
                        foundCount++;
                        // สร้าง URL ตรง (Direct URL)
                        const url = `${supabaseUrl}/storage/v1/object/public/responses/${userId}/${folder}/${file.name}`;

                        playlist.innerHTML += `
                            <div class="audio-step-card shadow-sm">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="badge bg-primary-subtle text-primary border border-primary">ขั้นตอน ${folder}</span>
                                    <small class="text-muted" style="font-size:10px;">${file.name.substring(0,10)}...</small>
                                </div>
                                <audio controls class="w-100" style="height:35px;" preload="metadata">
                                    <source src="${url}" type="audio/webm">
                                </audio>
                                <div class="text-end mt-2">
                                    <a href="${url}" target="_blank" class="text-decoration-none small text-secondary">
                                        <i class="bi bi-box-arrow-up-right"></i> เปิดดูไฟล์
                                    </a>
                                </div>
                            </div>`;
                    });
                }
            }
            document.getElementById('loader').innerHTML = foundCount > 0 ? `<span class="text-success fw-bold">✅ พบ ${foundCount} ไฟล์เสียง</span>` : `<span class="text-danger">❌ ไม่พบไฟล์ในห้อง S1-S5</span>`;
            document.getElementById('statAudio').innerText = foundCount;
        };

        // 4. ระบบ Filter และ Export
        function populateFilterOptions(data) {
            const groups = [...new Set(data.map(i => i.user_group).filter(Boolean))];
            const levels = [...new Set(data.map(i => i.staff_level).filter(Boolean))];
            
            const gSelect = document.getElementById('filterGroup');
            const lSelect = document.getElementById('filterLevel');

            if(gSelect.options.length <= 1) groups.forEach(g => gSelect.add(new Option(g, g)));
            if(lSelect.options.length <= 1) levels.forEach(l => lSelect.add(new Option(l, l)));
        }

        document.getElementById('applyFilters').onclick = fetchSubmissions;

        const updateTotal = () => {
            const sum = ['s1','s1_5','s2','s3','s4','s5'].reduce((acc, id) => acc + (parseInt(document.getElementById(id).value) || 0), 0);
            document.getElementById('totalScoreText').textContent = sum;
        };
        document.querySelectorAll('.score-input').forEach(i => i.oninput = updateTotal);

        // บันทึกคะแนน
        document.getElementById('saveScoreBtn').onclick = async () => {
            const score = document.getElementById('totalScoreText').textContent;
            const { error } = await supabase.from('submissions')
                .update({ 
                    manual_score: score, 
                    feedback: document.getElementById('feedback').value,
                    s1_score: document.getElementById('s1').value,
                    s1_5_score: document.getElementById('s1_5').value,
                    s2_score: document.getElementById('s2').value,
                    s3_score: document.getElementById('s3').value,
                    s4_score: document.getElementById('s4').value,
                    s5_score: document.getElementById('s5').value
                })
                .match({ user_id: activeUserId });
            
            if(!error) { 
                alert("บันทึกคะแนนสำเร็จ"); 
                fetchSubmissions(); 
                document.getElementById('scoringModal').style.display='none'; 
            }
        };

        // ออกรายงาน CSV
        document.getElementById('exportCsvBtn').onclick = () => {
            let csv = "\uFEFFวัน-เวลา,ชื่อพนักงาน,กลุ่ม,คะแนน\n";
            allSubmissions.forEach(row => {
                csv += `${row.created_at},${row.name},${row.user_group},${row.manual_score || 'N/A'}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "simulator_report.csv";
            link.click();
        };

        document.getElementById('logoutBtn').onclick = () => location.reload();
    </script>
</body>
</html>
