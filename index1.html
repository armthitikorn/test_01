<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Evaluation Dashboard (Integrated with Simulator)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f6; color: #34495e; }
        
        #loginPage { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%); }
        .main-content { display: none; padding: 20px; }
        .table-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .scoring-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 95%; max-width: 950px; max-height: 90vh; overflow-y: auto; }
        
        .step-audio-card { border-left: 5px solid #3498db; background: #f8f9fa; padding: 12px; margin-bottom: 12px; border-radius: 8px; }
        .audio-label { font-size: 0.85rem; font-weight: bold; color: #2c3e50; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="card shadow-lg p-4" style="width: 380px; border-radius: 15px;">
            <h3 class="text-center mb-4 fw-bold">Dashboard Login</h3>
            <input type="password" id="adminPass" class="form-control mb-3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="loginBtn" class="btn btn-primary w-100 fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="mainContent" class="main-content container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-primary"><i class="bi bi-person-video3"></i> Simulator Monitoring</h2>
            <div>
                <button id="downloadReportBtn" class="btn btn-outline-success me-2"><i class="bi bi-file-earmark-spreadsheet"></i> ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô CSV</button>
                <button id="logoutBtn" class="btn btn-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>

        <div class="table-container shadow-sm border">
            <div class="row g-3 mb-4">
                <div class="col-md-3"><label class="small fw-bold">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="startDate" class="form-control"></div>
                <div class="col-md-3"><label class="small fw-bold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="endDate" class="form-control"></div>
                <div class="col-md-2 d-flex align-items-end"><button id="filterBtn" class="btn btn-primary w-100"><i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th>
                            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
                            <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="submissionTable">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="scoring-modal">
        <div class="modal-content shadow-lg border-0">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•: <span id="modalTraineeName" class="text-primary"></span></h4>
                <button class="btn-close" onclick="document.getElementById('scoringModal').style.display='none'"></button>
            </div>
            
            <div class="row">
                <div class="col-md-6 border-end">
                    <h6 class="fw-bold mb-3"><i class="bi bi-play-circle-fill text-danger"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ (Step 1-5)</h6>
                    <div id="audioPlaylist" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                        </div>
                </div>

                <div class="col-md-6 ps-4">
                    <h6 class="fw-bold mb-3"><i class="bi bi-pencil-square text-success"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h6>
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="small">Step 1 (5)</label>
                            <input type="number" id="s1" class="form-control score-input" max="5">
                        </div>
                        <div class="col-6">
                            <label class="small">Step 2 (5)</label>
                            <input type="number" id="s2" class="form-control score-input" max="5">
                        </div>
                        <div class="col-6">
                            <label class="small">Step 3 (5)</label>
                            <input type="number" id="s3" class="form-control score-input" max="5">
                        </div>
                        <div class="col-6">
                            <label class="small">Step 4 (5)</label>
                            <input type="number" id="s4" class="form-control score-input" max="5">
                        </div>
                        <div class="col-6">
                            <label class="small">Step 5 (5)</label>
                            <input type="number" id="s5" class="form-control score-input" max="5">
                        </div>
                        <div class="col-12 mt-3">
                            <label class="small fw-bold">‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                            <textarea id="feedback" class="form-control" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á..."></textarea>
                        </div>
                    </div>
                    
                    <div class="bg-light p-3 rounded mt-4 text-center">
                        <h3 class="mb-0 fw-bold">‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="totalScore" class="text-primary">0</span> / 25</h3>
                    </div>
                    
                    <button id="saveScoreBtn" class="btn btn-success w-100 mt-4 btn-lg fw-bold shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Config Supabase ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        const supabase = createClient(supabaseUrl, supabaseKey);

        const VALID_PASS = '12345678';
        let allSubmissions = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Filter

        // ‡∏£‡∏∞‡∏ö‡∏ö Login
        document.getElementById('loginBtn').onclick = () => {
            if (document.getElementById('adminPass').value === VALID_PASS) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                fetchSubmissions();
            } else { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
        };

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° (Group by User ID) ---
        async function fetchSubmissions() {
            let query = supabase.from('submissions').select('*').order('created_at', { ascending: false });
            
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if (start && end) { query = query.gte('created_at', start).lte('created_at', end + 'T23:59:59'); }

            const { data, error } = await query;
            if(error) return;
            allSubmissions = data;

            // ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°: 1 ‡∏Ñ‡∏ô (user_id) ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà 1 ‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            const grouped = data.reduce((acc, current) => {
                const key = current.user_id || current.userid;
                if (!acc[key]) { acc[key] = current; }
                return acc;
            }, {});

            const tbody = document.getElementById('submissionTable');
            tbody.innerHTML = '';

            Object.values(grouped).forEach(item => {
                const uid = item.user_id || item.userid;
                tbody.innerHTML += `
                    <tr>
                        <td class="small">${new Date(item.created_at).toLocaleString('th-TH')}</td>
                        <td class="fw-bold">${item.name}</td>
                        <td>${item.user_group || '-'}</td>
                        <td>${item.insurance_type || '-'}</td>
                        <td><span class="badge ${item.manual_score ? 'bg-success' : 'bg-warning text-dark'}">${item.manual_score ? item.manual_score + ' ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' : '‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="window.openEvaluation('${uid}', '${item.name}')">‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button></td>
                    </tr>`;
            });
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡∏Å‡∏ß‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Bucket ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ---
        window.openEvaluation = (userId, name) => {
            document.getElementById('modalTraineeName').textContent = name;
            document.getElementById('scoringModal').style.display = 'flex';
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° Step
            const userSteps = allSubmissions
                .filter(s => (s.user_id === userId || s.userid === userId))
                .sort((a, b) => a.part_number - b.part_number);
            
            const playlist = document.getElementById('audioPlaylist');
            playlist.innerHTML = '';
            
            userSteps.forEach(step => {
                if(!step.audio_url) return;
                playlist.innerHTML += `
                    <div class="step-audio-card shadow-sm">
                        <span class="audio-label">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${step.part_number}: ${step.question_text || '‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤'}</span>
                        <div class="d-flex align-items-center gap-2">
                            <audio controls src="${step.audio_url}" class="flex-grow-1" style="height: 35px;"></audio>
                            ${step.customer_audio_url ? `<button class="btn btn-sm btn-info text-white" onclick="new Audio('${step.customer_audio_url}').play()">üîà ‡πÇ‡∏à‡∏ó‡∏¢‡πå</button>` : ''}
                        </div>
                    </div>`;
            });

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
            const firstWithScore = userSteps.find(s => s.manual_score);
            document.getElementById('s1').value = firstWithScore?.s1_score || '';
            document.getElementById('s2').value = firstWithScore?.s2_score || '';
            document.getElementById('feedback').value = firstWithScore?.feedback || '';
            updateTotal();
            window.currentUserIdForSave = userId;
        };

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const updateTotal = () => {
            const sum = ['s1','s2','s3','s4','s5'].reduce((acc, id) => acc + (parseInt(document.getElementById(id).value) || 0), 0);
            document.getElementById('totalScore').textContent = sum;
        };
        document.querySelectorAll('.score-input').forEach(input => input.oninput = updateTotal);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        document.getElementById('saveScoreBtn').onclick = async () => {
            const total = document.getElementById('totalScore').textContent;
            const { error } = await supabase.from('submissions')
                .update({ 
                    manual_score: total, 
                    feedback: document.getElementById('feedback').value,
                    s1_score: document.getElementById('s1').value,
                    s2_score: document.getElementById('s2').value,
                    s3_score: document.getElementById('s3').value,
                    s4_score: document.getElementById('s4').value,
                    s5_score: document.getElementById('s5').value
                })
                .match({ user_id: window.currentUserIdForSave });

            if(!error) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); fetchSubmissions(); document.getElementById('scoringModal').style.display='none'; }
        };

        document.getElementById('filterBtn').onclick = fetchSubmissions;
        document.getElementById('logoutBtn').onclick = () => location.reload();
    </script>
</body>
</html>
