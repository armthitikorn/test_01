<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>E-Simulator Roleplay (Final Fixed)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
            -webkit-text-size-adjust: 100%;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        h1 { font-size: 28px; color: #d9534f; margin-bottom: 20px; }
        h2 { margin-top: 25px; font-size: 22px; color: #337ab7; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        button {
            padding: 12px 24px;
            font-size: 18px;
            cursor: pointer;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 8px;
            margin: 10px;
            transition: all 0.3s ease;
            font-family: 'Sarabun', sans-serif;
            font-weight: bold;
        }
        button:hover { background-color: #4cae4c; transform: translateY(-2px); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-stop { background-color: #d9534f; }
        .btn-stop:hover { background-color: #c9302c; }
        .btn-next { background-color: #f0ad4e; }
        
        .setup-section, .test-section { margin-bottom: 30px; text-align: left; }
        .instruction { font-size: 16px; color: #666; margin-bottom: 15px; line-height: 1.6; }
        .status-recording { color: #d9534f; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity:1;} 50% {opacity:0.4;} 100% {opacity:1;} }
        
        input[type="text"], select {
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box;
        }
        .radio-group { display: flex; gap: 20px; margin: 10px 0; }
        
        #certificate {
            display: none; margin-top: 30px; padding: 40px; border: 10px double #d9534f; background: #fff; position: relative;
        }
        #certificate h2 { border: none; color: #d9534f; font-size: 32px; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #d9534f;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingText" style="margin-top:15px; font-weight:bold;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div class="container-box">
        <h1>üéôÔ∏è Sales E-Simulator</h1>
        
        <div id="setup" class="setup-section">
            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
            <input type="text" id="inputUserName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            <label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î/‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô:</label>
            <input type="text" id="inputUserGroup" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô">
            
            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label>
            <div class="radio-group">
                <label><input type="radio" name="difficulty" value="easy" checked> ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥ (Easy)</label>
                <label><input type="radio" name="difficulty" value="hard"> ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ (Hard)</label>
            </div>
            
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô:</label>
            <select id="productType">
                <option value="CI">CI Super Care</option>
                <option value="Life">Life Care 20/99</option>
            </select>
            <button id="startTestBtn" style="width:100%; margin:20px 0;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>

        <div id="section1" class="test-section" style="display:none;">
            <h2>Step 1: ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®</h2>
            <p class="instruction" id="s1_instruction"></p>
            <audio id="customerAudio" style="width:100%; margin-bottom:10px;"></audio>
            <div id="s1_status"></div>
            <button id="recordBtn">üé§ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ</button>
            <button id="nextRoundBtn" class="btn-next" style="display:none;">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            <button id="nextSection2Btn" class="btn-next" style="display:none;">‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <div id="section2" class="test-section" style="display:none;">
            <h2>Step 2: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (Pitching)</h2>
            <p class="instruction">‡πÇ‡∏õ‡∏£‡∏î‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
            <div id="s2_status"></div>
            <button id="pitchRecordBtn">üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
            <button id="nextSection3Btn" class="btn-next" style="display:none;">‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <div id="section3" class="test-section" style="display:none;">
            <h2>Step 3: ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</h2>
            <p class="instruction">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏á‡∏™‡∏±‡∏¢... ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <button id="startQBtn">üîà ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            <div id="s3_status" style="margin-top:10px;"></div>
            <button id="answerBtn" style="display:none;">üé§ ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
            <button id="closeBtn" style="display:none;">üé§ ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
            <button id="replyBtn" style="display:none;">üé§ ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
            <button id="nextSection4Btn" class="btn-next" style="display:none;">‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <div id="section4" class="test-section" style="display:none;">
            <h2>Step 4: ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á</h2>
            <p class="instruction">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏•‡∏±‡∏á‡πÄ‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô...</p>
            <div id="s4_status"></div>
            <button id="answerHBtn">üé§ ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</button>
            <button id="nextSection5Btn" class="btn-next" style="display:none;">‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</button>
        </div>

        <div id="section5" class="test-section" style="display:none;">
            <h2>Step 5: ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
            <p class="instruction">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏≥‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <div id="s5_status"></div>
            <button id="answerABtn">üé§ ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
            <button id="finalSaveBtn" class="btn-next" style="display:none; background-color: #28a745;">‚úÖ ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>

        <div id="certificate">
            <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</h2>
            <p style="font-size: 20px;">‡∏Ñ‡∏∏‡∏ì <strong><span id="traineeName"></span></strong></p>
            <p>‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Sales E-Simulator ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
            <div style="margin: 20px 0; font-style: italic;">"‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"</div>
            <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö: <span id="issueDate"></span></p>
            <button id="certBtn" style="background:#d9534f;">‡∏î‡∏π‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

    <script type="module">
        // --- 1. Supabase Config (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
        const supabaseUrl = 'https://YOUR_PROJECT_URL.supabase.co';
        const supabaseKey = 'YOUR_ANON_KEY';
        window.supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- 2. Variables ---
        let mediaRecorder;
        let audioChunks = [];
        let allRecordings = [];
        let currentUserId = "";
        let selectedProductType = "";
        let scenarioRound = 1;
        let currentCustomerAudioUrl = "";

        const questions = [
            "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏û‡∏≠‡∏î‡∏µ‡∏™‡∏ô‡πÉ‡∏à‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?",
            "‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö?",
            "‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?",
            "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Å‡∏µ‡πà‡∏õ‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö?",
            "‡∏ñ‡πâ‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó‡∏Ñ‡∏£‡∏±‡∏ö?"
        ];

        // --- 3. Functions ---
        const uuidv4 = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));

        const startTest = () => {
            const name = document.getElementById("inputUserName").value;
            const group = document.getElementById("inputUserGroup").value;
            if(!name || !group) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            
            currentUserId = `user_${Date.now()}`;
            selectedProductType = document.getElementById("productType").value;
            document.getElementById("setup").style.display = "none";
            document.getElementById("section1").style.display = "block";
            initSection1_5();
        };

        const initSection1_5 = () => {
            if(scenarioRound <= 5) {
                document.getElementById("s1_instruction").textContent = `‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${scenarioRound}: ${questions[scenarioRound-1]}`;
                document.getElementById("nextRoundBtn").style.display = "none";
                document.getElementById("recordBtn").style.display = "inline-block";
                document.getElementById("s1_status").innerHTML = "";
                // ‡∏à‡∏≥‡∏•‡∏≠‡∏á URL ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÉ‡∏ô‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Storage)
                currentCustomerAudioUrl = `https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3`; 
            } else {
                document.getElementById("recordBtn").style.display = "none";
                document.getElementById("nextSection2Btn").style.display = "inline-block";
            }
        };

        const toggleRecording = async (step) => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                return;
            }
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                handleStopRecording(step, blob);
            };
            
            mediaRecorder.start();
            updateUIStatus(step, true);
        };

        const updateUIStatus = (step, isRecording) => {
            const statusId = `s${step}_status`;
            const btnId = step === 1 ? "recordBtn" : (step === 8 ? "pitchRecordBtn" : (step === 2 ? "answerBtn" : (step === 3 ? "closeBtn" : (step === 4 ? "replyBtn" : (step === 5 ? "answerHBtn" : "answerABtn")))));
            const btn = document.getElementById(btnId);
            if(isRecording) {
                document.getElementById(statusId).innerHTML = '<p class="status-recording">üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...</p>';
                btn.textContent = "‚èπÔ∏è ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏π‡∏î";
                btn.classList.add("btn-stop");
            } else {
                document.getElementById(statusId).innerHTML = '<p style="color:green;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';
                btn.textContent = "üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà";
                btn.classList.remove("btn-stop");
            }
        };

        const handleStopRecording = (step, blob) => {
            const diff = document.querySelector('input[name="difficulty"]:checked').value;
            let qText = "";
            let part = 0;

            if(step === 1) { part = 1; qText = questions[scenarioRound-1]; }
            else if(step === 8) { part = 2; qText = "Pitching Product Content"; }
            else if(step === 2) { part = 3; qText = "Objection Handling"; }
            else if(step === 3) { part = 3; qText = "Closing Sale Immediately"; }
            else if(step === 4) { part = 3; qText = "Additional Reply"; }
            else if(step === 5) { part = 4; qText = "Hard Objection: Premium"; }
            else if(step === 6) { part = 5; qText = "Final Closing Summary"; }

            allRecordings.push({
                part: part,
                qNum: scenarioRound,
                qText: qText,
                audioBlob: blob,
                customerAudioUrl: currentCustomerAudioUrl
            });

            updateUIStatus(step, false);
            if(step === 1) {
                scenarioRound++;
                document.getElementById("nextRoundBtn").style.display = "inline-block";
            } else if(step === 8) document.getElementById("nextSection3Btn").style.display = "inline-block";
            else if(step === 2 || step === 3 || step === 4) document.getElementById("nextSection4Btn").style.display = "inline-block";
            else if(step === 5) document.getElementById("nextSection5Btn").style.display = "inline-block";
            else if(step === 6) document.getElementById("finalSaveBtn").style.display = "inline-block";
        };

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Upload ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö Dashboard ---
        const uploadAll = async () => {
            document.getElementById('loadingOverlay').style.display = "flex";
            document.getElementById('loadingText').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á Dashboard...";
            
            let successCount = 0;
            const diff = document.querySelector('input[name="difficulty"]:checked').value;
            const userName = document.getElementById("inputUserName").value;
            const userGroup = document.getElementById("inputUserGroup").value;

            for (let i = 0; i < allRecordings.length; i++) {
                const rec = allRecordings[i];
                const fileName = `${currentUserId}/S${rec.part}_Q${i}_${uuidv4()}.webm`;
                
                // 1. Upload File to Storage
                const { error: upErr } = await window.supabase.storage.from('responses').upload(fileName, rec.audioBlob);
                
                if(!upErr) {
                    const { data: { publicUrl } } = window.supabase.storage.from('responses').getPublicUrl(fileName);
                    
                    // 2. Insert Data to Table (‡πÄ‡∏û‡∏¥‡πà‡∏° Customer Audio ‡πÅ‡∏•‡∏∞ Diff Tag)
                    await window.supabase.from('submissions').insert([{
                        user_id: currentUserId, 
                        name: userName, 
                        part_number: rec.part, 
                        question_number: rec.qNum, 
                        question_text: `${rec.qText} (${diff})`, 
                        audio_url: publicUrl,
                        customer_audio_url: rec.customerAudioUrl,
                        insurance_type: selectedProductType, 
                        user_group: userGroup
                    }]);
                    successCount++;
                }
            }

            // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•" (Summary Row) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Dashboard ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ
            if (successCount > 0) {
                await window.supabase.from('submissions').insert([{
                    user_id: currentUserId,
                    name: userName,
                    part_number: 0, // ‡πÄ‡∏•‡∏Ç 0 ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å
                    question_text: `‚≠ê ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏ß‡∏° (${diff})`,
                    insurance_type: selectedProductType,
                    user_group: userGroup,
                    manual_score: null 
                }]);
            }

            document.getElementById('loadingOverlay').style.display = "none";
            
            if(successCount > 0) { 
                document.getElementById("finalSaveBtn").textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; 
                document.getElementById("finalSaveBtn").disabled = true;
                document.getElementById('certificate').style.display = 'block';
                document.getElementById('traineeName').textContent = userName;
                document.getElementById('issueDate').textContent = new Date().toLocaleDateString('th-TH');
                document.getElementById("certificate").scrollIntoView({behavior: "smooth"});
            } else {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
            }
        };

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Navigation ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
        const initSection2 = () => { 
            document.getElementById("section1").style.display="none"; 
            document.getElementById("section2").style.display="block"; 
        };
        const initSection3 = () => { 
            document.getElementById("section2").style.display="none"; 
            document.getElementById("section3").style.display="block"; 
        };
        const playS2 = () => {
            document.getElementById("s3_status").innerHTML = "üîà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...";
            setTimeout(() => {
                document.getElementById("s3_status").innerHTML = "‚úÖ ‡∏ü‡∏±‡∏á‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏≠‡∏ö";
                document.getElementById("answerBtn").style.display = "inline-block";
                document.getElementById("closeBtn").style.display = "inline-block";
                document.getElementById("replyBtn").style.display = "inline-block";
            }, 2000);
        };
        const initSection4 = () => { 
            document.getElementById("section3").style.display="none"; 
            document.getElementById("section4").style.display="block"; 
        };
        const initSection5 = () => { 
            document.getElementById("section4").style.display="none"; 
            document.getElementById("section5").style.display="block"; 
        };

        const init = async () => {
            document.getElementById("startTestBtn").onclick = startTest;
            document.getElementById("recordBtn").onclick = () => toggleRecording(1);
            document.getElementById("nextRoundBtn").onclick = initSection1_5;
            document.getElementById("pitchRecordBtn").onclick = () => toggleRecording(8);
            document.getElementById("nextSection2Btn").onclick = initSection2;
            document.getElementById("startQBtn").onclick = playS2;
            document.getElementById("answerBtn").onclick = () => toggleRecording(2);
            document.getElementById("closeBtn").onclick = () => toggleRecording(3);
            document.getElementById("replyBtn").onclick = () => toggleRecording(4);
            document.getElementById("nextSection3Btn").onclick = initSection3;
            document.getElementById("nextSection4Btn").onclick = initSection4;
            document.getElementById("answerHBtn").onclick = () => toggleRecording(5);
            document.getElementById("nextSection5Btn").onclick = initSection5;
            document.getElementById("answerABtn").onclick = () => toggleRecording(6);
            document.getElementById("finalSaveBtn").onclick = uploadAll;
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
